(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();function Tt(t){const e=t/100;let n,o,r;return n=255,o=Math.min(255,Math.max(0,99.4708025861*Math.log(e)-161.1195681661)),r=Math.min(255,Math.max(0,138.5177312231*Math.log(e-10)-305.0447927307)),[n/255,o/255,r/255]}function At(t){const e=l=>Math.max(0,Math.min(1,l));let n=0,o=0,r=0;n=1,o=15/65,r=0;const a=1;return[e(n*a),e(o*a),e(r*a)]}const ht=Tt(3e3),kt=At(),st=[.95,.5,.2],dt=[.15,.08,.2];function vt(t,e,n){return[t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n,t[2]+(e[2]-t[2])*n]}const xt=[st,dt,vt(st,dt,.5),vt(st,dt,.75)],It=[[.95,.55,.2],[.75,.3,.15],[.45,.2,.18],[.25,.12,.15],[.12,.06,.08]],Pt=[[.9,.4,.15],[.95,.5,.25],[.85,.35,.2],[.7,.28,.18],[.5,.2,.15],[.35,.15,.12]];function $(t){return[Math.max(0,Math.min(1,t[0])),Math.max(0,Math.min(1,t[1])),Math.max(0,Math.min(1,t[2]))]}function zt(t,e=3){const n=t.slice(0,e),o=n.reduce((r,a)=>r+a,0);return o<=0?Array(e).fill(1/e):n.map(r=>r/o)}const Ft={spot:{beamAngle:30,hotspotOffset:.5},color:{gradientMode:"radial",transitionCurve:.5,horizon:{colors:xt.map(t=>[...t]),numColors:2,horizonY:.5,softness:.35,tilt:0},multiRing:{numRings:3,ringColors:It.slice(0,5).map(t=>[...t]),ringWidths:[.35,.35,.3,.2,.2],smoothness:.4,ringBlend:.35},sector:{numSectors:4,sectorColors:Pt.slice(0,6).map(t=>[...t]),centerRgb:[...ht],radialBlend:.5}},edge:{penumbraWidth:.4,chromaticFringeEnabled:!1,chromaticFringe:.3,chromaticFringeRgb:[.4,.25,.6],breathingEnabled:!1,wobbleAmount:.03,wobbleSpeed:.4,trajectoryEnabled:!1,trajectoryDiameter:.15,trajectoryEdgeHardness:.3,trajectorySpeed:.4,trajectoryTrail:.3,trajectoryRgb:[1,.5,.2]},scene:{wallTint:[.08,.06,.05],lightRgb:[...ht],edgeRgb:[...kt],bloom:.5,softBlurEnabled:!1,softBlur:.35,haze:0,movingLightEnabled:!1,movingLightIntensity:.6,movingLightSpread:.25,movingLightDynamic:.5,movingLightRange:.5,movingLightIrregular:!1}};function lt(t){var e,n,o,r;return{spot:(()=>{const a=t.spot;let l=Number(a.hotspotOffset??.5);if(a.distortionHotspotOffset!==void 0){const c=Number(a.distortionHotspotOffset);l=c<=-1?0:c>=1?1:.5-c*.5}return{beamAngle:Math.max(15,Math.min(45,t.spot.beamAngle)),hotspotOffset:Math.max(0,Math.min(1,l))}})(),color:{gradientMode:(()=>{const a=t.color.gradientMode;return a==="radial"||a==="horizon"||a==="multiRing"||a==="sector"?a:"radial"})(),transitionCurve:Math.max(0,Math.min(1,t.color.transitionCurve??.5)),horizon:(()=>{const a=t.color.horizon;let l=((a==null?void 0:a.colors)??[]).slice(0,4).map($);for(l.length<2&&(a!=null&&a.topRgb||a!=null&&a.bottomRgb)&&(l=[$(a.topRgb??st),$(a.bottomRgb??dt)]);l.length<4;)l.push([...xt[l.length]]);const c=Math.max(2,Math.min(4,(a==null?void 0:a.numColors)??2));return{colors:l,numColors:c,horizonY:Math.max(0,Math.min(1,(a==null?void 0:a.horizonY)??.5)),softness:Math.max(0,Math.min(1,(a==null?void 0:a.softness)??.35)),tilt:Math.max(-1,Math.min(1,(a==null?void 0:a.tilt)??0))}})(),multiRing:(()=>{var c,d,E,f,C;const a=Math.max(3,Math.min(5,((c=t.color.multiRing)==null?void 0:c.numRings)??3));let l=((d=t.color.multiRing)==null?void 0:d.ringWidths)??[.35,.35,.3,.2,.2];for(l=l.slice(0,5);l.length<a;)l.push(1/a);return{numRings:a,ringColors:(((E=t.color.multiRing)==null?void 0:E.ringColors)??It).slice(0,5).map($),ringWidths:zt(l,a),smoothness:Math.max(0,Math.min(1,((f=t.color.multiRing)==null?void 0:f.smoothness)??.4)),ringBlend:Math.max(0,Math.min(1,((C=t.color.multiRing)==null?void 0:C.ringBlend)??.35))}})(),sector:{numSectors:Math.max(3,Math.min(6,((e=t.color.sector)==null?void 0:e.numSectors)??4)),sectorColors:(((n=t.color.sector)==null?void 0:n.sectorColors)??Pt).slice(0,6).map($),centerRgb:$(((o=t.color.sector)==null?void 0:o.centerRgb)??ht),radialBlend:Math.max(0,Math.min(1,((r=t.color.sector)==null?void 0:r.radialBlend)??.5))}},edge:{penumbraWidth:Math.max(0,Math.min(1,t.edge.penumbraWidth)),chromaticFringeEnabled:!!t.edge.chromaticFringeEnabled,chromaticFringe:Math.max(.01,Math.min(1,t.edge.chromaticFringe??.3)),chromaticFringeRgb:$(t.edge.chromaticFringeRgb??[.4,.25,.6]),breathingEnabled:!!t.edge.breathingEnabled,wobbleAmount:Math.max(0,Math.min(.06,t.edge.wobbleAmount??.03)),wobbleSpeed:Math.max(0,Math.min(.6,t.edge.wobbleSpeed??.4)),trajectoryEnabled:!!t.edge.trajectoryEnabled,trajectoryDiameter:Math.max(.1,Math.min(.2,t.edge.trajectoryDiameter??.15)),trajectoryEdgeHardness:Math.max(0,Math.min(1,t.edge.trajectoryEdgeHardness??.3)),trajectorySpeed:Math.max(0,Math.min(1,t.edge.trajectorySpeed??.4)),trajectoryTrail:Math.max(0,Math.min(1,t.edge.trajectoryTrail??.3)),trajectoryRgb:$(t.edge.trajectoryRgb??[1,.5,.2])},scene:{wallTint:$(t.scene.wallTint),lightRgb:$(t.scene.lightRgb??ht),edgeRgb:$(t.scene.edgeRgb??kt),bloom:Math.max(0,Math.min(1,t.scene.bloom??.5)),softBlurEnabled:!!t.scene.softBlurEnabled,softBlur:Math.max(.01,Math.min(1,t.scene.softBlur??.35)),haze:Math.max(0,Math.min(1,t.scene.haze??0)),movingLightEnabled:!!t.scene.movingLightEnabled,movingLightIntensity:Math.max(0,Math.min(1,t.scene.movingLightIntensity??.6)),movingLightSpread:Math.max(0,Math.min(1,t.scene.movingLightSpread??.25)),movingLightDynamic:Math.max(0,Math.min(1,t.scene.movingLightDynamic??.5)),movingLightRange:Math.max(0,Math.min(1,t.scene.movingLightRange??.5)),movingLightIrregular:!!t.scene.movingLightIrregular}}}const Kt=Math.PI/180,Dt=.4;function Gt(t,e,n){const o=t.spot.beamAngle,r=Math.tan(o*Kt);return Math.min(e,n)*.45*r/(1+r*.5)}function _t(t){return{scaleX:1,scaleY:1,hotspotOffsetY:(.5-Math.max(0,Math.min(1,t??.5)))*2*Dt}}function Wt(t){const n=.15+.35*t;return{r0:.65,r1:Math.min(1,.65+n)}}function Mt(t,e,n){const o=Gt(t,e,n),{scaleX:r,scaleY:a,hotspotOffsetY:l}=_t(t.spot.hotspotOffset??.5),{r0:c,r1:d}=Wt(t.edge.penumbraWidth);return{radius:o,scaleX:r,scaleY:a,penumbraR0:c,penumbraR1:d,hotspotOffsetY:l}}function Et(t,e){const n=2-1.5*e;return Math.pow(t,n)}function ut(t,e){const n=t.scene.lightRgb,o=t.scene.edgeRgb??t.scene.lightRgb,r=e.penumbraR0,a=e.penumbraR1,l=t.color.transitionCurve,c=t.edge.chromaticFringeEnabled!==!1,d=t.edge.chromaticFringe,E=t.edge.chromaticFringeRgb??[.4,.25,.6],f=[];f.push({t:0,r:n[0],g:n[1],b:n[2],a:1});const C=Math.max(0,Math.min(1,Et(r,l))),y=Math.max(0,Math.min(1,Et(a,l))),B=(C+y)*.5,N=(C+B)*.5,h=(B+y)*.5;if(f.push({t:C*.5,r:n[0],g:n[1],b:n[2],a:.96}),f.push({t:C,r:o[0],g:o[1],b:o[2],a:.88}),f.push({t:N,r:o[0],g:o[1],b:o[2],a:.65}),f.push({t:B,r:o[0],g:o[1],b:o[2],a:.4}),f.push({t:h,r:o[0],g:o[1],b:o[2],a:.18}),f.push({t:y,r:o[0],g:o[1],b:o[2],a:0}),c&&d>.005){const g=.008+.085*d,i=Math.max(C,y-g);if(i<y){const u=(i+y)*.5,M=.12+.2*d,j=.03+.08*d;f.push({t:i,r:E[0],g:E[1],b:E[2],a:j}),f.push({t:u,r:E[0],g:E[1],b:E[2],a:M}),f.push({t:y,r:E[0],g:E[1],b:E[2],a:0})}}for(const g of f)g.t=Math.max(0,Math.min(1,g.t));return f.sort((g,i)=>g.t-i.t),f}function Yt(t,e){const n=t.scene.edgeRgb??t.scene.lightRgb,o=Math.max(0,Math.min(1,e.penumbraR0)),r=Math.max(o+.01,Math.min(1,e.penumbraR1)),a=(o+r)*.5,l=(o+a)*.5,c=(a+r)*.5,d=[{t:0,r:n[0],g:n[1],b:n[2],a:0},{t:o,r:n[0],g:n[1],b:n[2],a:.88},{t:l,r:n[0],g:n[1],b:n[2],a:.65},{t:a,r:n[0],g:n[1],b:n[2],a:.4},{t:c,r:n[0],g:n[1],b:n[2],a:.18},{t:r,r:n[0],g:n[1],b:n[2],a:0},{t:1,r:n[0],g:n[1],b:n[2],a:0}];for(const E of d)E.t=Math.max(0,Math.min(1,E.t));return d.sort((E,f)=>E.t-f.t),d}function Nt(t){const e=t.scene.edgeRgb??t.scene.lightRgb,o=.12*(t.scene.bloom??.5);return[{t:0,r:e[0],g:e[1],b:e[2],a:0},{t:.25,r:e[0],g:e[1],b:e[2],a:o*.25},{t:.5,r:e[0],g:e[1],b:e[2],a:o*.6},{t:.75,r:e[0],g:e[1],b:e[2],a:o*.85},{t:1,r:e[0],g:e[1],b:e[2],a:0}]}function Ht(t){const e=t.penumbraR0,n=t.penumbraR1,o=(e+n)*.5;return[{t:0,r:1,g:1,b:1,a:1},{t:Math.max(0,Math.min(1,e*.95)),r:1,g:1,b:1,a:1},{t:Math.max(0,Math.min(1,e)),r:1,g:1,b:1,a:.98},{t:Math.max(0,Math.min(1,o)),r:1,g:1,b:1,a:.5},{t:Math.max(0,Math.min(1,n)),r:1,g:1,b:1,a:0},{t:1,r:1,g:1,b:1,a:0}]}function $t(t,e){const n=e.penumbraR1,o=t.edge.chromaticFringe,r=t.edge.chromaticFringeRgb??[.4,.25,.6],a=.02+.1*o,l=Math.max(0,n-a),c=Math.min(1,n+a),d=(l+n)*.5,E=.1+.22*o,f=.02+.06*o,C=[{t:0,r:r[0],g:r[1],b:r[2],a:0},{t:Math.max(0,l-.01),r:r[0],g:r[1],b:r[2],a:0},{t:l,r:r[0],g:r[1],b:r[2],a:f},{t:d,r:r[0],g:r[1],b:r[2],a:E},{t:n,r:r[0],g:r[1],b:r[2],a:f},{t:c,r:r[0],g:r[1],b:r[2],a:0},{t:1,r:r[0],g:r[1],b:r[2],a:0}];for(const y of C)y.t=Math.max(0,Math.min(1,y.t));return C.sort((y,B)=>y.t-B.t),C}function Jt(t){var y,B,N;const{numRings:e,ringColors:n,ringWidths:o,smoothness:r,ringBlend:a}=t.color.multiRing,l=Math.min(e,n.length,o.length),c=[];let d=0;const E=r*.15,f=E+a*.22,C=(h,g,i)=>[h[0]+(g[0]-h[0])*i,h[1]+(g[1]-h[1])*i,h[2]+(g[2]-h[2])*i];for(let h=0;h<l;h++){const g=o[h]??1/l,i=n[h]??[.5,.3,.2],u=Math.min(1,d+g);if(h===0)c.push({t:0,r:i[0],g:i[1],b:i[2],a:1}),c.push({t:Math.min(u-f,u),r:i[0],g:i[1],b:i[2],a:1});else{const M=n[h-1]??i,j=Math.max(0,d-f),D=Math.min(1,d+f),G=C(M,i,.5);c.push({t:j,r:M[0],g:M[1],b:M[2],a:1}),c.push({t:d,r:G[0],g:G[1],b:G[2],a:1}),c.push({t:D,r:i[0],g:i[1],b:i[2],a:1}),u-D>.001&&c.push({t:u-E,r:i[0],g:i[1],b:i[2],a:1})}if(d=u,d>=1)break}c.push({t:1,r:((y=n[l-1])==null?void 0:y[0])??.2,g:((B=n[l-1])==null?void 0:B[1])??.1,b:((N=n[l-1])==null?void 0:N[2])??.1,a:0});for(const h of c)h.t=Math.max(0,Math.min(1,h.t));return c.sort((h,g)=>h.t-g.t),c}const gt=Math.PI*2;function Ut(t,e){let n=t-e;for(;n>Math.PI;)n-=gt;for(;n<-Math.PI;)n+=gt;return n}function bt(t,e,n){const r=Ut(t,e)/n;return Math.exp(-r*r)}function Ct(t,e,n){const o=(n-t)/(e-t),r=Math.max(0,Math.min(1,o));return r*r*(3-2*r)}function Xt(t,e,n,o,r){const E=Ct(.45,.67,t),f=1-Ct(1.25-.28,1.25,t),C=E*f,y=.15+(2.5-.15)*Math.max(0,Math.min(1,r)),B=n*y,N=B+gt/3,h=B+2*gt/3,g=Math.sin(n*1.1),i=Math.sin(n*1.4+1.3),u=Math.sin(n*.9+2.1),M=g*bt(e,B,.6),j=i*bt(e,N,.6),D=u*bt(e,h,.6),G=M+j+D;return o*2*C*G}function U(t,e){for(const n of e){const{t:o,r,g:a,b:l,a:c}=n,d=Math.max(0,Math.min(1,o));t.addColorStop(d,`rgba(${Math.round(r*255)},${Math.round(a*255)},${Math.round(l*255)},${c})`)}}function qt(t,e,n,o){t.globalCompositeOperation="destination-in";const r=X(t,n,o);if(U(r,Ht(n)),t.fillStyle=r,t.beginPath(),t.arc(0,0,o,0,Math.PI*2),t.fill(),t.globalCompositeOperation="source-over",e.edge.chromaticFringeEnabled&&e.edge.chromaticFringe>.005){const a=X(t,n,o*1.08);U(a,$t(e,n)),t.fillStyle=a,t.beginPath(),t.arc(0,0,o*1.08,0,Math.PI*2),t.fill()}}function ft(t,e,n,o,r){const l=Math.ceil(o*2*1.25)+4,c=document.createElement("canvas");c.width=l,c.height=l;const d=c.getContext("2d");d.translate(l/2,l/2),r(d),qt(d,e,n,o),t.drawImage(c,-l/2,-l/2)}function Vt(t,e,n){const{colors:o,numColors:r,horizonY:a,softness:l,tilt:c}=e.color.horizon,d=Math.max(2,Math.min(4,r)),E=c*(Math.PI/4),f=Math.sin(E)*n*2,C=Math.cos(E)*n*2,y=t.createLinearGradient(-f/2,-C/2,f/2,C/2),B=Math.max(.001,Math.min(1,l)),N=Math.max(0,Math.min(1,a-B/2)),h=Math.max(0,Math.min(1,a+B/2)),g=Math.max(.001,h-N),i=o[0]??[.5,.3,.2],u=o[d-1]??i;y.addColorStop(0,Y(i,1)),y.addColorStop(N,Y(i,1));for(let M=0;M<d;M++){const j=M/(d-1),D=N+g*j,G=o[M]??i;y.addColorStop(D,Y(G,1))}y.addColorStop(h,Y(u,1)),y.addColorStop(1,Y(u,1)),t.fillStyle=y,t.beginPath(),t.arc(0,0,n,0,Math.PI*2),t.fill()}const Zt=26,Qt=25,te=24;let Z=null;function ee(){if(Z)return Z;const t=128;Z=document.createElement("canvas"),Z.width=t,Z.height=t;const e=Z.getContext("2d"),n=e.getImageData(0,0,t,t),o=n.data;for(let r=0;r<t;r++)for(let a=0;a<t;a++){const l=(r*t+a)*4,c=(Math.random()-.5)*25+(Math.random()-.5)*15,d=Math.max(0,Math.min(255,128+c));o[l]=o[l+1]=o[l+2]=d,o[l+3]=Math.floor(Math.random()*14+6)}return e.putImageData(n,0,0),Z}function ne(t,e,n,o){t.fillStyle=`rgb(${Zt},${Qt},${te})`,t.fillRect(0,0,e,n);const r=Math.min(1,.12+o[0]*.15),a=Math.min(1,.115+o[1]*.15),l=Math.min(1,.11+o[2]*.15),c=Math.round(r*255),d=Math.round(a*255),E=Math.round(l*255);t.fillStyle=`rgb(${c},${d},${E})`,t.fillRect(0,0,e,n);const f=t.createRadialGradient(e/2,n/2,0,e/2,n/2,Math.max(e,n)*.75);f.addColorStop(0,"rgba(0,0,0,0)"),f.addColorStop(.55,"rgba(0,0,0,0)"),f.addColorStop(1,"rgba(0,0,0,0.5)"),t.fillStyle=f,t.fillRect(0,0,e,n);const C=t.createPattern(ee(),"repeat");C&&(t.globalAlpha=.45,t.fillStyle=C,t.fillRect(0,0,e,n),t.globalAlpha=1)}let q=null;function Ot(t){if(q&&q.width===t)return q;q=document.createElement("canvas"),q.width=t,q.height=t;const e=q.getContext("2d"),n=e.getImageData(0,0,t,t),o=n.data;for(let r=0;r<o.length;r+=4){const a=128+(Math.random()-.5)*40;o[r]=o[r+1]=o[r+2]=a,o[r+3]=Math.random()*12+4}return e.putImageData(n,0,0),q}function oe(t,e,n,o,r,a){t.save(),t.translate(e,n),t.scale(r,a),t.beginPath(),t.arc(0,0,o*1.15,0,Math.PI*2),t.clip();const l=Ot(64),c=t.createPattern(l,"repeat");c&&(t.globalAlpha=.35,t.fillStyle=c,t.fillRect(-o*2,-o*2,o*4,o*4)),t.restore()}function St(t,e,n,o,r){const a=n.radius;t.save(),t.translate(o,r),t.scale(n.scaleX,n.scaleY);const l=X(t,n,a);U(l,Yt(e,n)),t.fillStyle=l,t.beginPath(),t.arc(0,0,a,0,Math.PI*2),t.fill(),t.restore()}function re(t,e,n,o,r,a,l,c){const d=e.edge.trajectoryDiameter??.15,E=e.edge.trajectoryEdgeHardness??.3,f=e.edge.trajectorySpeed??.4,C=e.edge.trajectoryTrail??.3,y=n.radius*d,B=.25+1.6*f,N=-o*B,h=e.edge.trajectoryRgb??e.scene.edgeRgb??e.scene.lightRgb,g={...e,scene:{...e.scene,edgeRgb:h},edge:{...e.edge,penumbraWidth:Math.max(.05,e.edge.penumbraWidth*(.35+.65*E))}},i=Mt(g,l,c),u={...e,edge:{...e.edge,penumbraWidth:1}},M=Mt(u,l,c),j=8;if(C>.02)for(let S=j;S>=1;S--){const p=N+S*.12,T=r+y*Math.cos(p),A=a+y*Math.sin(p),K=C*.52*(1-S/j);t.save(),t.globalAlpha=K,St(t,g,i,T,A),t.restore()}const D=r+y*Math.cos(N),G=a+y*Math.sin(N);St(t,g,i,D,G),t.save(),Rt(t,u,M,r,a),t.restore()}function ae(t,e,n,o,r){t.save(),t.translate(o,r),t.scale(n.scaleX,n.scaleY),Bt(t,e,n),t.restore()}function le(t,e,n,o,r){const a=e.scene.bloom??0;if(a<=.01)return;const l=n.radius*(1.7+.8*a);t.save(),t.translate(o,r),t.scale(n.scaleX,n.scaleY);const c=X(t,n,l);U(c,Nt(e)),t.fillStyle=c,t.beginPath(),t.arc(0,0,l,0,Math.PI*2),t.fill(),t.restore()}function X(t,e,n){const o=n*(e.hotspotOffsetY??0);return t.createRadialGradient(0,o,0,0,0,n)}function Rt(t,e,n,o,r){const a=e.scene.bloom??0;if(t.translate(o,r),t.scale(n.scaleX,n.scaleY),a>.01){const l=n.radius*(1.7+.8*a),c=X(t,n,l);U(c,Nt(e)),t.fillStyle=c,t.beginPath(),t.arc(0,0,l,0,Math.PI*2),t.fill()}Bt(t,e,n)}function Bt(t,e,n){const o=e.color.gradientMode??"radial",r=n.radius;if(o==="radial"){const l=X(t,n,r);U(l,ut(e,n)),t.fillStyle=l,t.beginPath(),t.arc(0,0,r,0,Math.PI*2),t.fill();return}if(o==="horizon"){ft(t,e,n,r,l=>Vt(l,e,r));return}if(o==="multiRing"){ft(t,e,n,r,l=>{const c=X(l,n,r);U(c,Jt(e)),l.fillStyle=c,l.beginPath(),l.arc(0,0,r,0,Math.PI*2),l.fill()});return}if(o==="sector"){ft(t,e,n,r,l=>{const{numSectors:c,sectorColors:d,centerRgb:E,radialBlend:f}=e.color.sector,C=Math.min(c,d.length),y=l.createConicGradient;if(typeof y=="function"){const i=y.call(l,0,0,0);for(let u=0;u<=C;u++){const M=d[u%C]??d[0];i.addColorStop(u/C,Y(M,1))}l.fillStyle=i,l.beginPath(),l.arc(0,0,r,0,Math.PI*2),l.fill()}else{const i=X(l,n,r);U(i,ut(e,n)),l.fillStyle=i,l.beginPath(),l.arc(0,0,r,0,Math.PI*2),l.fill()}const B=r*.3,N=r*(n.hotspotOffsetY??0),h=l.createRadialGradient(0,N,B,0,0,r),g=f*.45;h.addColorStop(0,Y(E,0)),h.addColorStop(1,Y(E,g)),l.fillStyle=h,l.beginPath(),l.arc(0,0,r,0,Math.PI*2),l.fill()});return}const a=X(t,n,r);U(a,ut(e,n)),t.fillStyle=a,t.beginPath(),t.arc(0,0,r,0,Math.PI*2),t.fill()}function pt(t){return Math.round(Math.max(0,Math.min(1,t))*255)}function Y(t,e){return`rgba(${pt(t[0])},${pt(t[1])},${pt(t[2])},${e})`}function ce(t,e,n){return[t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n,t[2]+(e[2]-t[2])*n]}function ie(t,e,n,o,r,a){if(!e.scene.movingLightEnabled)return;const l=e.scene.edgeRgb??e.scene.lightRgb,c=e.scene.movingLightIntensity??.6,d=e.scene.movingLightSpread??.25,E=e.scene.movingLightDynamic??.5,f=e.scene.movingLightRange??.5,C=e.scene.movingLightIrregular===!0,y=n.radius;t.save(),t.translate(r,a),t.scale(n.scaleX,n.scaleY);const B=t.globalCompositeOperation;t.globalCompositeOperation="screen";const N=o,h=C?5:3;for(let u=0;u<h;u++){const M=u/Math.max(1,h-1),j=.7+.18*u,D=1.21+.13*u,G=.93+.16*u,S=Math.sin(N*j)+.6*Math.sin(N*D+1.7*u),p=Math.cos(N*G+.9)+.5*Math.sin(N*(j*.8)+2.3*u),T=y*(.25+.6*f),A=S*T*.35,K=p*T*.35,v=y*(.6+.4*d+.35*f+.18*M),k=(N*(.06+.03*u+.05*E)+M*.27)%1,P=[.5+.5*Math.cos(6.28318*(k+0)),.5+.5*Math.cos(6.28318*(k+.33)),.5+.5*Math.cos(6.28318*(k+.67))],s=.3+.3*M,I=Math.max(0,Math.min(1,s+E*.5)),b=ce(l,P,I),m=.7+(.3+.5*E)*Math.sin(N*(1.3+.4*u)+M*3.1),w=c*(.4+.6*M)*m,R=w*.15,x=C?6:1;for(let L=0;L<x;L++){const z=C?L*(Math.PI/3)+1.1*Math.sin(N*(.7+.15*L)+L*1.3):0,O=C?v*(.25+.35*Math.sin(N*.8+L*.9)):0,F=C?A+Math.cos(z)*O:A,W=C?K+Math.sin(z)*O:K,V=C?v*(.7+.4*Math.abs(Math.sin(N*(1.1+.3*L)+M*2.1))):v,H=t.createRadialGradient(F,W,0,F,W,V);H.addColorStop(0,Y(b,w)),H.addColorStop(.32,Y(b,w*.45)),H.addColorStop(.82,Y(b,R)),H.addColorStop(1,Y(b,0)),t.fillStyle=H,t.fillRect(-y*2,-y*2,y*4,y*4)}}const g=Ot(64),i=t.createPattern(g,"repeat");i&&(t.globalCompositeOperation="soft-light",t.globalAlpha=.22,t.fillStyle=i,t.fillRect(-y*2,-y*2,y*4,y*4)),t.globalCompositeOperation=B,t.restore()}function se(t,e,n,o,r,a){const l=t.width,c=t.height,{radius:d,scaleX:E,scaleY:f}=n,C=e.edge.wobbleAmount??.03,y=e.edge.wobbleSpeed??.4,[B,N,h]=e.scene.wallTint,g=Math.min(255,Math.round((.12+B*.15)*255)),i=Math.min(255,Math.round((.115+N*.15)*255)),u=Math.min(255,Math.round((.11+h*.15)*255)),M=Math.max(0,Math.floor(r-d*E*1.05)),j=Math.max(0,Math.floor(a-d*f*1.05)),D=Math.min(l,Math.ceil(r+d*E*1.05)),G=Math.min(c,Math.ceil(a+d*f*1.05)),S=D-M,p=G-j,T=t.getContext("2d").getImageData(M,j,S,p),A=t.getContext("2d").getImageData(M,j,S,p);for(let K=j;K<G;K++)for(let v=M;v<D;v++){const k=(v-r)/E,P=(K-a)/f,I=Math.sqrt(k*k+P*P)/d;if(I>1.05)continue;const b=Math.atan2(P,k),m=Xt(I,b,o,C,y),w=Math.max(0,Math.min(1.05,I+m)),R=r+w*d*Math.cos(b)*E,x=a+w*d*Math.sin(b)*f,L=Math.round(R-M),z=Math.round(x-j),O=z*S+L,F=(K-j)*S+(v-M);L>=0&&L<S&&z>=0&&z<p?(A.data[F*4]=T.data[O*4],A.data[F*4+1]=T.data[O*4+1],A.data[F*4+2]=T.data[O*4+2],A.data[F*4+3]=T.data[O*4+3]):(A.data[F*4]=g,A.data[F*4+1]=i,A.data[F*4+2]=u,A.data[F*4+3]=255)}t.getContext("2d").putImageData(A,M,j)}function ct(t,e,n){const o=t.canvas,r=o.width,a=o.height,l=r/2,c=a/2,d=Mt(e,r,a),E=e.scene.softBlur??0,f=e.edge.breathingEnabled&&E>.02,C=e.scene.haze??0,y=e.edge.breathingEnabled&&n!=null,B=e.edge.trajectoryEnabled&&n!=null,N=e.scene.movingLightEnabled&&n!=null,h=y||B||f&&E>.02;let g=null;h&&(g=document.createElement("canvas"),g.width=r,g.height=a);const i=h?g.getContext("2d"):t;if(ne(i,r,a,e.scene.wallTint),h&&g?B?re(i,e,d,n,l,c,r,a):y?(ae(i,e,d,l,c),se(g,e,d,n,l,c),le(i,e,d,l,c)):(i.save(),Rt(i,e,d,l,c),i.restore()):(t.save(),Rt(t,e,d,l,c),t.restore()),N){const u=h&&g?g.getContext("2d"):t;ie(u,e,d,n,l,c)}if(h&&g)if(f&&E>.02){const u=Math.max(2,Math.round(50*E)),M=document.createElement("canvas");M.width=r,M.height=a;const j=M.getContext("2d");j.filter=`blur(${u}px)`,j.drawImage(g,0,0),t.drawImage(M,0,0)}else t.drawImage(g,0,0);if(!y&&!B&&oe(t,l,c,d.radius,d.scaleX,d.scaleY),C>.01){const u=document.createElement("canvas");u.width=r,u.height=a;const M=u.getContext("2d"),j=Math.max(4,Math.round(18+32*C));M.filter=`blur(${j}px)`,M.drawImage(o,0,0),t.save(),t.globalAlpha=.3+.4*C,t.drawImage(u,0,0),t.restore()}}function Q(t,e,n){const o=r=>Math.round(Math.max(0,Math.min(1,r))*255);return"#"+[o(t),o(e),o(n)].map(r=>r.toString(16).padStart(2,"0")).join("")}function tt(t){const e=parseInt(t.slice(1),16);return Number.isNaN(e)?[0,0,0]:[(e>>16)/255,(e>>8&255)/255,(e&255)/255]}function et(t,e){let n=t;for(const r of e)n=n[r];const o=n;return[o[0],o[1],o[2]]}function nt(t,e,n){let o=t;for(let l=0;l<e.length-1;l++){const c=e[l];o=o[c]}const r=e[e.length-1],a=o[r];!a||!Array.isArray(a)||(a[0]=Math.max(0,Math.min(1,n[0])),a[1]=Math.max(0,Math.min(1,n[1])),a[2]=Math.max(0,Math.min(1,n[2])))}const it=[{key:"beamAngle",path:["spot","beamAngle"],label:"束角",min:15,max:45,step:1,format:t=>`${t}°`},{key:"hotspotOffset",path:["spot","hotspotOffset"],label:"射灯偏移",min:0,max:1,step:.02},{key:"transitionCurve",path:["color","transitionCurve"],label:"过渡梯度",min:0,max:1,step:.02},{key:"horizonY",path:["color","horizon","horizonY"],label:"地平线位置",min:0,max:1,step:.02},{key:"softness",path:["color","horizon","softness"],label:"过渡柔和度",min:0,max:1,step:.02},{key:"tilt",path:["color","horizon","tilt"],label:"倾斜",min:-1,max:1,step:.05},{key:"smoothness",path:["color","multiRing","smoothness"],label:"环间过渡",min:0,max:1,step:.02},{key:"ringBlend",path:["color","multiRing","ringBlend"],label:"环间混合",min:0,max:1,step:.02},{key:"radialBlend",path:["color","sector","radialBlend"],label:"径向混合",min:0,max:1,step:.02},{key:"penumbraWidth",path:["edge","penumbraWidth"],label:"半影区宽度",min:0,max:1,step:.02},{key:"wobbleAmount",path:["edge","wobbleAmount"],label:"形变强度",min:0,max:.06,step:.005},{key:"wobbleSpeed",path:["edge","wobbleSpeed"],label:"形变速度",min:0,max:.6,step:.02},{key:"trajectoryDiameter",path:["edge","trajectoryDiameter"],label:"轨迹直径",min:.1,max:.2,step:.01},{key:"trajectoryEdgeHardness",path:["edge","trajectoryEdgeHardness"],label:"边缘柔软",min:0,max:1,step:.02},{key:"trajectorySpeed",path:["edge","trajectorySpeed"],label:"运动速度",min:0,max:1,step:.02},{key:"trajectoryTrail",path:["edge","trajectoryTrail"],label:"拖影效果",min:0,max:1,step:.02},{key:"chromaticFringe",path:["edge","chromaticFringe"],label:"强度",min:.01,max:1,step:.01},{key:"bloom",path:["scene","bloom"],label:"外圈光晕",min:0,max:1,step:.02},{key:"haze",path:["scene","haze"],label:"朦胧感",min:0,max:1,step:.02},{key:"softBlur",path:["scene","softBlur"],label:"边缘硬度",min:.01,max:1,step:.02},{key:"movingLightIntensity",path:["scene","movingLightIntensity"],label:"亮度",min:0,max:1,step:.02},{key:"movingLightSpread",path:["scene","movingLightSpread"],label:"扩散",min:0,max:1,step:.02},{key:"movingLightDynamic",path:["scene","movingLightDynamic"],label:"动态变化强度",min:0,max:1,step:.02},{key:"movingLightRange",path:["scene","movingLightRange"],label:"运动范围",min:0,max:1,step:.02}],de=[{togglePath:["edge","chromaticFringeEnabled"],toggleLabel:"色散",subSliderKey:"chromaticFringe"}],wt=[{key:"breathing",togglePath:["edge","breathingEnabled"],toggleLabel:"呼吸",subSliderKeys:["wobbleAmount","wobbleSpeed","softBlur"]},{key:"trajectory",togglePath:["edge","trajectoryEnabled"],toggleLabel:"轨迹",subSliderKeys:["trajectoryDiameter","trajectoryEdgeHardness","trajectorySpeed","trajectoryTrail"],subColorKeys:["trajectoryRgb"]},{key:"movingLight",togglePath:["scene","movingLightEnabled"],toggleLabel:"动光",subSliderKeys:["movingLightIntensity","movingLightSpread","movingLightDynamic","movingLightRange"]}],yt=[{key:"lightRgb",path:["scene","lightRgb"],label:"中心颜色"},{key:"edgeRgb",path:["scene","edgeRgb"],label:"边缘颜色"},{key:"horizonColor0",path:["color","horizon","colors",0],label:"颜色1"},{key:"horizonColor1",path:["color","horizon","colors",1],label:"颜色2"},{key:"horizonColor2",path:["color","horizon","colors",2],label:"颜色3"},{key:"horizonColor3",path:["color","horizon","colors",3],label:"颜色4"},{key:"ringColor0",path:["color","multiRing","ringColors",0],label:"环1"},{key:"ringColor1",path:["color","multiRing","ringColors",1],label:"环2"},{key:"ringColor2",path:["color","multiRing","ringColors",2],label:"环3"},{key:"ringColor3",path:["color","multiRing","ringColors",3],label:"环4"},{key:"ringColor4",path:["color","multiRing","ringColors",4],label:"环5"},{key:"sectorCenterRgb",path:["color","sector","centerRgb"],label:"中心颜色"},{key:"sectorColor0",path:["color","sector","sectorColors",0],label:"扇区1"},{key:"sectorColor1",path:["color","sector","sectorColors",1],label:"扇区2"},{key:"sectorColor2",path:["color","sector","sectorColors",2],label:"扇区3"},{key:"sectorColor3",path:["color","sector","sectorColors",3],label:"扇区4"},{key:"sectorColor4",path:["color","sector","sectorColors",4],label:"扇区5"},{key:"sectorColor5",path:["color","sector","sectorColors",5],label:"扇区6"},{key:"chromaticFringeRgb",path:["edge","chromaticFringeRgb"],label:"色散颜色"},{key:"trajectoryRgb",path:["edge","trajectoryRgb"],label:"轨迹颜色"}];function _(t,e){let n=t;for(const o of e)n=n[o];return n}function J(t,e,n){let o=t;for(let r=0;r<e.length-1;r++){const a=e[r];o=o[a]}o[e[e.length-1]]=n}function ot(t,e){let n=t;for(const o of e)n=n[o];return!!n}function rt(t,e,n){let o=t;for(let r=0;r<e.length-1;r++){const a=e[r];o=o[a]}o[e[e.length-1]]=n}function he(t,e,n,o){const r={radial:"径向",horizon:"地平线",multiRing:"多环",sector:"扇形"},a=["radial","horizon","multiRing","sector"],l={radial:["transitionCurve"],horizon:["horizonY","softness","tilt"],multiRing:["smoothness","ringBlend"],sector:["radialBlend"]},c={radial:["lightRgb","edgeRgb"],horizon:["horizonColor0","horizonColor1","horizonColor2","horizonColor3"],multiRing:["ringColor0","ringColor1","ringColor2","ringColor3","ringColor4"],sector:["sectorCenterRgb","sectorColor0","sectorColor1","sectorColor2","sectorColor3","sectorColor4","sectorColor5"]};function d(S,p,T){const A=document.createElement("div");A.className="control-row";const K=document.createElement("label");K.textContent=p.label;const v=document.createElement("input");v.type="range",v.min=String(p.min),v.max=String(p.max),v.step=String(p.step);const k=document.createElement("span");k.className="value";const P=()=>{const s=Number(v.value);J(e,[...p.path],s),k.textContent=p.format?p.format(s):s.toFixed(2),T(e)};v.value=String(_(e,p.path)),k.textContent=p.format?p.format(Number(v.value)):Number(v.value).toFixed(2),v.addEventListener("input",P),A.append(K,v,k),S.appendChild(A)}function E(S,p,T){const A=document.createElement("div");A.className="control-row control-row-color";const K=document.createElement("label");K.textContent=p.label;const v=document.createElement("input");v.type="color",v.className="color-picker";const k=et(e,p.path);v.value=Q(k[0],k[1],k[2]),v.addEventListener("input",()=>{nt(e,p.path,tt(v.value)),T(e)}),A.append(K,v),S.appendChild(A)}const f=(S,p)=>C(S,p);function C(S,p){S.innerHTML="";const T=l[p],A=c[p];let K=999;p==="horizon"&&(K=Math.min(4,Math.max(2,_(e,["color","horizon","numColors"])))),p==="multiRing"&&(K=Math.min(5,Math.max(3,_(e,["color","multiRing","numRings"])))),p==="sector"&&(K=Math.min(6,Math.max(3,_(e,["color","sector","numSectors"]))));for(const v of T){const k=it.find(P=>P.key===v);k&&d(S,k,n)}if(p==="horizon"){const v=Math.min(4,Math.max(2,_(e,["color","horizon","numColors"])));for(let b=0;b<v;b++){const m=document.createElement("div");m.className="control-row control-row-color";const w=document.createElement("label");w.textContent=`颜色${b+1}`;const R=document.createElement("input");R.type="color",R.className="color-picker";const x=["color","horizon","colors",b],L=et(e,x);if(R.value=Q(L[0],L[1],L[2]),R.addEventListener("input",()=>{nt(e,x,tt(R.value)),n(e)}),m.append(w,R),v>2){const z=document.createElement("button");z.type="button",z.textContent="−",z.addEventListener("click",()=>{const O=Math.min(4,Math.max(2,_(e,["color","horizon","numColors"])));if(!(O<=2)){for(let F=b;F<O-1;F++){const W=e.color.horizon.colors[F+1]??e.color.horizon.colors[F];e.color.horizon.colors[F]=[...W]}J(e,["color","horizon","numColors"],O-1),n(e),f(S,p)}}),m.appendChild(z)}S.appendChild(m)}const k=document.createElement("div");k.className="control-row";const P=document.createElement("label");P.textContent="增加颜色";const s=document.createElement("button");s.type="button",s.textContent="+";const I=Math.min(4,Math.max(2,_(e,["color","horizon","numColors"])));s.disabled=I>=4,s.addEventListener("click",()=>{const b=Math.min(4,Math.max(2,_(e,["color","horizon","numColors"])));if(b>=4)return;const m=e.color.horizon.colors[b-1]??e.color.horizon.colors[0]??[.5,.3,.2];e.color.horizon.colors[b]=[...m],J(e,["color","horizon","numColors"],b+1),n(e),f(S,p)}),k.append(P,s),S.appendChild(k);return}if(p==="multiRing"){const v=Math.min(5,Math.max(3,_(e,["color","multiRing","numRings"])));for(let b=0;b<v;b++){const m=document.createElement("div");m.className="control-row control-row-color";const w=document.createElement("label");w.textContent=`环${b+1}`;const R=document.createElement("input");R.type="color",R.className="color-picker";const x=["color","multiRing","ringColors",b],L=et(e,x);if(R.value=Q(L[0],L[1],L[2]),R.addEventListener("input",()=>{nt(e,x,tt(R.value)),n(e)}),m.append(w,R),v>3&&b===v-1){const z=document.createElement("button");z.type="button",z.textContent="−",z.addEventListener("click",()=>{const O=Math.min(5,Math.max(3,_(e,["color","multiRing","numRings"])));O<=3||(J(e,["color","multiRing","numRings"],O-1),n(e),f(S,p))}),m.appendChild(z)}S.appendChild(m)}const k=document.createElement("div");k.className="control-row";const P=document.createElement("label");P.textContent="环数";const s=document.createElement("button");s.type="button",s.textContent="+";const I=Math.min(5,Math.max(3,_(e,["color","multiRing","numRings"])));s.disabled=I>=5,s.addEventListener("click",()=>{const b=Math.min(5,Math.max(3,_(e,["color","multiRing","numRings"])));if(b>=5)return;const m=e.color.multiRing.ringColors[b-1]??e.color.multiRing.ringColors[0]??[.5,.3,.2];e.color.multiRing.ringColors[b]=[...m],J(e,["color","multiRing","numRings"],b+1),n(e),f(S,p)}),k.append(P,s),S.appendChild(k);return}if(p==="sector"){const v=Math.min(6,Math.max(3,_(e,["color","sector","numSectors"])));for(let b=0;b<v;b++){const m=document.createElement("div");m.className="control-row control-row-color";const w=document.createElement("label");w.textContent=`扇区${b+1}`;const R=document.createElement("input");R.type="color",R.className="color-picker";const x=["color","sector","sectorColors",b],L=et(e,x);if(R.value=Q(L[0],L[1],L[2]),R.addEventListener("input",()=>{nt(e,x,tt(R.value)),n(e)}),m.append(w,R),v>3&&b===v-1){const z=document.createElement("button");z.type="button",z.textContent="−",z.addEventListener("click",()=>{const O=Math.min(6,Math.max(3,_(e,["color","sector","numSectors"])));O<=3||(J(e,["color","sector","numSectors"],O-1),n(e),f(S,p))}),m.appendChild(z)}S.appendChild(m)}const k=document.createElement("div");k.className="control-row";const P=document.createElement("label");P.textContent="扇区数";const s=document.createElement("button");s.type="button",s.textContent="+";const I=Math.min(6,Math.max(3,_(e,["color","sector","numSectors"])));s.disabled=I>=6,s.addEventListener("click",()=>{const b=Math.min(6,Math.max(3,_(e,["color","sector","numSectors"])));if(b>=6)return;const m=e.color.sector.sectorColors[b-1]??e.color.sector.sectorColors[0]??[.9,.4,.15];e.color.sector.sectorColors[b]=[...m],J(e,["color","sector","numSectors"],b+1),n(e),f(S,p)}),k.append(P,s),S.appendChild(k);return}for(const v of A){let k=!0;if(p==="horizon"&&v.startsWith("horizonColor")?k=parseInt(v.replace("horizonColor",""),10)<K:p==="multiRing"&&v.startsWith("ringColor")?k=parseInt(v.replace("ringColor",""),10)<K:p==="sector"&&(v==="sectorCenterRgb"?k=!0:v.startsWith("sectorColor")&&(k=parseInt(v.replace("sectorColor",""),10)<K)),!k)continue;const P=yt.find(s=>s.key===v);P&&E(S,P,n)}}const y=document.createElement("div");y.className="panel-title",y.textContent="YUI LIGHT",t.appendChild(y);const B=document.createElement("div");B.className="control-group",B.innerHTML="<h3>色彩渐变</h3>";const N=document.createElement("div");N.className="control-row";const h=document.createElement("label");h.textContent="渐变类型";const g=document.createElement("select");g.className="gradient-mode-select";for(const S of a){const p=document.createElement("option");p.value=S,p.textContent=r[S],(e.color.gradientMode??"radial")===S&&(p.selected=!0),g.appendChild(p)}N.append(h,g),B.appendChild(N);const i=document.createElement("div");i.className="color-mode-params",C(i,e.color.gradientMode??"radial"),B.appendChild(i),g.addEventListener("change",()=>{e.color.gradientMode=g.value,C(i,g.value),n(e)});const u={spot:{title:"光斑形态",sliderKeys:["beamAngle","hotspotOffset"],colorKeys:[]},color:{title:"色彩渐变",sliderKeys:["transitionCurve"],colorKeys:["lightRgb","edgeRgb"],toggleSliderKeys:[],toggleMultiSliderKeys:[]},edge:{title:"边缘质感",sliderKeys:["penumbraWidth"],colorKeys:["chromaticFringeRgb"],toggleSliderKeys:["chromaticFringe"],toggleMultiSliderKeys:[]},scene:{title:"场景",sliderKeys:["bloom","haze"],colorKeys:[],toggleSliderKeys:[],toggleMultiSliderKeys:[]},dynamics:{title:"动态光效",sliderKeys:[],colorKeys:[],toggleSliderKeys:[],toggleMultiSliderKeys:["breathing","trajectory","movingLight"]}};let M=null,j=null,D=null;const G={};for(const[S,{title:p,sliderKeys:T,colorKeys:A,toggleSliderKeys:K,toggleMultiSliderKeys:v}]of Object.entries(u)){const k=document.createElement("div");if(k.className="control-group",k.innerHTML=`<h3>${p}</h3>`,S==="color"){const P=document.createElement("div");P.className="control-group",P.innerHTML="<h3>色彩渐变</h3>";const s=document.createElement("div");s.className="control-row";const I=document.createElement("label");I.textContent="渐变类型";const b=document.createElement("select");b.className="gradient-mode-select";for(const w of a){const R=document.createElement("option");R.value=w,R.textContent=r[w],(e.color.gradientMode??"radial")===w&&(R.selected=!0),b.appendChild(R)}s.append(I,b),P.appendChild(s);const m=document.createElement("div");m.className="color-mode-params",C(m,e.color.gradientMode??"radial"),P.appendChild(m),b.addEventListener("change",()=>{e.color.gradientMode=b.value,C(m,b.value),n(e)}),t.appendChild(P);continue}for(const P of T){const s=it.find(x=>x.key===P);if(!s)continue;const I=document.createElement("div");I.className="control-row";const b=document.createElement("label");b.textContent=s.label;const m=document.createElement("input");m.type="range",m.min=String(s.min),m.max=String(s.max),m.step=String(s.step);const w=document.createElement("span");w.className="value";const R=()=>{const x=Number(m.value);J(e,[...s.path],x),w.textContent=s.format?s.format(x):x.toFixed(2),n(e)};m.value=String(_(e,s.path)),w.textContent=s.format?s.format(Number(m.value)):Number(m.value).toFixed(2),m.addEventListener("input",R),I.append(b,m,w),k.appendChild(I)}for(const P of K??[]){const s=de.find(W=>W.subSliderKey===P);if(!s)continue;const I=it.find(W=>W.key===P);if(!I)continue;const b=document.createElement("div");b.className="control-row control-row-toggle";const m=document.createElement("label");m.textContent=s.toggleLabel;const w=document.createElement("input");w.type="checkbox",w.checked=ot(e,s.togglePath);const R=document.createElement("div");R.className="control-row control-row-indent",R.style.display=w.checked?"":"none",S==="edge"&&P==="chromaticFringe"&&(M=w,j=R,w.disabled=ot(e,["edge","breathingEnabled"]),D&&(D.style.display=w.checked?"":"none"));const x=document.createElement("label");x.textContent=I.label;const L=document.createElement("input");L.type="range",L.min=String(I.min),L.max=String(I.max),L.step=String(I.step);const z=document.createElement("span");z.className="value";const O=()=>{const W=Number(L.value);J(e,[...I.path],W),z.textContent=I.format?I.format(W):W.toFixed(2),n(e)};let F=_(e,I.path);F<I.min&&(J(e,[...I.path],I.min),F=I.min,n(e)),L.value=String(F),z.textContent=I.format?I.format(F):F.toFixed(2),L.addEventListener("input",O),R.append(x,L,z),w.addEventListener("change",()=>{rt(e,s.togglePath,w.checked),R.style.display=w.checked?"":"none",S==="edge"&&P==="chromaticFringe"&&D&&(D.style.display=w.checked?"":"none"),n(e)}),b.append(m,w),k.appendChild(b),k.appendChild(R)}for(const P of v??[]){const s=wt.find(R=>R.key===P);if(!s)continue;const I=document.createElement("div");I.className="control-row control-row-toggle";const b=document.createElement("label");b.textContent=s.toggleLabel;const m=document.createElement("input");m.type="checkbox",m.checked=ot(e,s.togglePath);const w=document.createElement("div");if(w.className="control-row-indent-wrap",w.style.display=m.checked?"":"none",s.key==="movingLight"){const R=document.createElement("div");R.className="control-row control-row-toggle";const x=document.createElement("label");x.textContent="不规则形状";const L=document.createElement("input");L.type="checkbox",L.checked=ot(e,["scene","movingLightIrregular"]),L.addEventListener("change",()=>{rt(e,["scene","movingLightIrregular"],L.checked),n(e)}),R.append(x,L),w.appendChild(R)}for(const R of s.subSliderKeys){const x=it.find(H=>H.key===R);if(!x)continue;const L=document.createElement("div");L.className="control-row control-row-indent";const z=document.createElement("label");z.textContent=x.label;const O=document.createElement("input");O.type="range",O.min=String(x.min),O.max=String(x.max),O.step=String(x.step);const F=document.createElement("span");F.className="value";const W=()=>{const H=Number(O.value);J(e,[...x.path],H),F.textContent=x.format?x.format(H):H.toFixed(2),n(e)};let V=_(e,x.path);V=Math.max(x.min,Math.min(x.max,V)),O.value=String(V),F.textContent=x.format?x.format(V):V.toFixed(2),O.addEventListener("input",W),L.append(z,O,F),w.appendChild(L)}for(const R of s.subColorKeys??[]){const x=yt.find(W=>W.key===R);if(!x)continue;const L=document.createElement("div");L.className="control-row control-row-indent control-row-color";const z=document.createElement("label");z.textContent=x.label;const O=document.createElement("input");O.type="color",O.className="color-picker";const F=et(e,x.path);O.value=Q(F[0],F[1],F[2]),O.addEventListener("input",()=>{nt(e,x.path,tt(O.value)),n(e)}),L.append(z,O),w.appendChild(L)}m.addEventListener("change",()=>{if(rt(e,s.togglePath,m.checked),w.style.display=m.checked?"":"none",S==="edge"&&s.key==="breathing"&&M&&(M.disabled=m.checked,m.checked&&(rt(e,["edge","chromaticFringeEnabled"],!1),M.checked=!1,j&&(j.style.display="none"))),S==="dynamics"&&m.checked){G[s.key]={input:m,wrap:w};const R=["breathing","trajectory","movingLight"];if(R.includes(s.key))for(const x of R){if(x===s.key)continue;const L=G[x];if(!L)continue;L.input.checked=!1;const z=wt.find(O=>O.key===x);z&&rt(e,z.togglePath,!1),L.wrap.style.display="none"}}n(e)}),S==="edge"&&s.key==="breathing"&&M&&(M.disabled=m.checked),S==="dynamics"&&(G[s.key]={input:m,wrap:w}),I.append(b,m),k.appendChild(I),k.appendChild(w)}for(const P of A){const s=yt.find(R=>R.key===P);if(!s)continue;const I=document.createElement("div");I.className="control-row control-row-color";const b=document.createElement("label");b.textContent=s.label;const m=document.createElement("input");m.type="color",m.className="color-picker";const w=et(e,s.path);m.value=Q(w[0],w[1],w[2]),m.addEventListener("input",()=>{const R=tt(m.value);nt(e,s.path,R),n(e)}),S==="edge"&&s.key==="chromaticFringeRgb"&&(D=I,ot(e,["edge","chromaticFringeEnabled"])||(I.style.display="none")),I.append(b,m),k.appendChild(I)}t.appendChild(k)}if(o!=null&&o.onSavePreset||o!=null&&o.onExportPresets||o!=null&&o.onImportPresets){const S=document.createElement("div");S.className="control-group control-group-save";const p=document.createElement("div");if(p.className="control-row",p.style.gap="0.5rem",p.style.flexWrap="wrap",o.onSavePreset){const T=document.createElement("button");T.type="button",T.textContent="保存",T.className="save-preset-btn",T.addEventListener("click",()=>o.onSavePreset()),p.appendChild(T)}if(o.onExportPresets){const T=document.createElement("button");T.type="button",T.textContent="导出预设",T.className="save-preset-btn",T.addEventListener("click",()=>o.onExportPresets()),p.appendChild(T)}if(o.onImportPresets){const T=document.createElement("button");T.type="button",T.textContent="导入预设",T.className="save-preset-btn";const A=document.createElement("input");A.type="file",A.accept=".json,.txt",A.style.display="none",A.addEventListener("change",()=>{var v;const K=(v=A.files)==null?void 0:v[0];K&&o.onImportPresets(K),A.value=""}),T.addEventListener("click",()=>A.click()),p.appendChild(T),p.appendChild(A)}S.appendChild(p),t.appendChild(S)}}const mt="halo-light-presets";function jt(){return"p_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8)}function at(){try{const t=localStorage.getItem(mt);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}function ge(t,e){const n={id:jt(),params:JSON.parse(JSON.stringify(t)),thumbnail:e,createdAt:Date.now()},o=at();return o.push(n),localStorage.setItem(mt,JSON.stringify(o)),n}function me(t){const e=at().filter(n=>n.id!==t);localStorage.setItem(mt,JSON.stringify(e))}function ue(){const t=at();return JSON.stringify(t,null,2)}function be(t){try{const e=JSON.parse(t);if(!Array.isArray(e))return 0;const n=at();for(const o of e)o!=null&&o.params&&typeof o.params=="object"&&n.push({id:o.id??jt(),params:o.params,thumbnail:typeof o.thumbnail=="string"?o.thumbnail:"",createdAt:typeof o.createdAt=="number"?o.createdAt:Date.now()});return localStorage.setItem(mt,JSON.stringify(n)),e.length}catch{return 0}}const Lt=80;function fe(){const t=document.getElementById("halo"),e=document.getElementById("panel"),n=document.getElementById("canvas-wrap");if(!t||!e||!n)return;let o={...lt(Ft)};const r=t.getContext("2d"),a=document.createElement("div");a.className="preset-thumbnails",n.appendChild(a);function l(h){const g=document.createElement("canvas");g.width=Lt,g.height=Lt;const i=g.getContext("2d"),M=h.edge.breathingEnabled||h.edge.trajectoryEnabled||h.scene.movingLightEnabled?performance.now()/1e3:void 0;return ct(i,h,M),g.toDataURL("image/jpeg",.88)}function c(){a.innerHTML="";const h=at();for(const g of h){const i=document.createElement("div");i.className="preset-thumb-wrap";const u=document.createElement("img");u.className="preset-thumb",u.src=g.thumbnail,u.alt="",u.title="点击应用",u.addEventListener("click",j=>{if(j.target.closest(".preset-thumb-delete"))return;const D=lt(JSON.parse(JSON.stringify(g.params)));o.spot=D.spot,o.color=D.color,o.edge=D.edge,o.scene=D.scene,B(o),C()});const M=document.createElement("button");M.className="preset-thumb-delete",M.type="button",M.title="删除预设",M.innerHTML="×",M.addEventListener("click",j=>{j.stopPropagation(),me(g.id),c()}),i.appendChild(u),i.appendChild(M),a.appendChild(i)}}function d(){const h=l(o);ge(o,h),c()}function E(){const h=ue(),g=new Blob([h],{type:"application/json"}),i=URL.createObjectURL(g),u=document.createElement("a");u.href=i,u.download=`夕阳灯预设_${new Date().toISOString().slice(0,10)}.json`,u.click(),URL.revokeObjectURL(i)}async function f(h){const g=await h.text(),i=be(g);c(),i>0&&B(o)}c();function C(){e.innerHTML="",he(e,o,B,{onSavePreset:d,onExportPresets:E,onImportPresets:h=>f(h)})}function y(){const h=t.parentElement,g=Math.min(2,window.devicePixelRatio||1);let i=h.clientWidth,u=h.clientHeight;(i<=0||u<=0)&&(i=Math.max(400,(window.innerWidth||800)-300),u=Math.max(300,(window.innerHeight||600)-40));const M=Math.floor(i*g),j=Math.floor(u*g);t.width=M,t.height=j,t.style.width=i+"px",t.style.height=u+"px";const G=o.edge.breathingEnabled||o.edge.trajectoryEnabled||o.scene.movingLightEnabled?performance.now()/1e3:void 0;ct(r,o,G)}function B(h){h!==void 0?o=lt(h):o=lt(o);const i=o.edge.breathingEnabled||o.edge.trajectoryEnabled||o.scene.movingLightEnabled?performance.now()/1e3:void 0;ct(r,o,i)}C(),window.addEventListener("resize",y),y(),requestAnimationFrame(()=>y()),window.addEventListener("load",y);function N(){if(o.edge.breathingEnabled||o.edge.trajectoryEnabled||o.scene.movingLightEnabled){const g=performance.now()/1e3;ct(r,o,g)}requestAnimationFrame(N)}requestAnimationFrame(N)}fe();
